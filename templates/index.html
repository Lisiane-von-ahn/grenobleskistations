
{% extends 'base.html' %}
{% load static %}
{% load base64_filters %}
{% load i18n %}

{% block title %}{% trans "Stations de Ski" %}{% endblock %}

{% block content %}
  
  <script src="{% static 'js/paginationski.js' %}"></script>

  <!-- ***** Main Banner Area Start ***** -->
  <section id="section-1">
    <div class="content-slider">
      <input type="radio" id="banner1" class="sec-1-input" name="banner" checked>
      <input type="radio" id="banner2" class="sec-1-input" name="banner">
      <input type="radio" id="banner3" class="sec-1-input" name="banner">
      <input type="radio" id="banner4" class="sec-1-input" name="banner">

      <div class="slider">
        {% for station in ski_stations %}
        <div id="top-banner-{{ forloop.counter }}" class="banner">
            <div class="banner-inner-wrapper header-text">
                <div class="main-caption">
                    <h1>{{ station.name }}</h1>
                    <div class="border-button">
                    <a href="{% url 'ski_station_detail' station.id %}">{% trans "Allez" %}</a>
                    </div>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="more-info">
                                <div class="row">
                                    <div class="col-lg-3 col-sm-6 col-6">
                                        <i class="fa fa-user"></i>
                                        <h4><span>{% trans "Capacité:" %}</span><br>{{ station.capacity }} {% trans "personnes" %}</h4>
                                    </div>
                                    <div class="col-lg-3 col-sm-6 col-6">
                                      <i class="fa fa-mountain"></i>
                                      <h4><span>{% trans "Altitude:" %}</span><br>{{ station.altitude }} m</h4>
                                  </div>
                                  <div class="col-lg-3 col-sm-6 col-6">
                                      <i class="fa fa-road"></i>
                                      <h4><span>{% trans "Distance de Grenoble:" %}</span><br>{{ station.distanceFromGrenoble }} km</h4>
                                  </div>                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
      </div>
    
      <nav>
        <div class="controls">
          <label for="banner1"><span class="progressbar"><span class="progressbar-fill"></span></span><span class="text">1</span></label>
          <label for="banner2"><span class="progressbar"><span class="progressbar-fill"></span></span><span class="text">2</span></label>
          <label for="banner3"><span class="progressbar"><span class="progressbar-fill"></span></span><span class="text">3</span></label>
          <label for="banner4"><span class="progressbar"><span class="progressbar-fill"></span></span><span class="text">4</span></label>
        </div>
      </nav>
    </div>
  </section>
  <!-- ***** Main Banner Area End ***** -->
  
  <div class="visit-country">
    <div class="container">
        <div class="row">
            <div class="col-lg-5">
                <div class="section-heading">
                  <h2>{% trans "Visitez l'une de nos stations de ski dès maintenant" %}</h2>
                  <p>{% trans "Découvrez les meilleures stations de ski que nous proposons, avec des informations détaillées et des visuels époustouflants." %}</p>                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-8">
                <div id="ski-station-list" class="items">
                    <div class="row">
                        {% for station in ski_stations %}
                        <div class="col-lg-12 station-item">
                            <div class="item">
                                <div class="row">
                                    <div class="col-lg-4 col-sm-5">
                                        <div class="image">
                                            {% if station.image %}
                                            <img src="data:image/jpeg;base64,{{ station.image|b64encode }}" alt="{{ station.name }}">
                                            {% else %}
                                            <img src="{% static 'images/default.jpg' %}" alt="Default image">
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-lg-8 col-sm-7">
                                        <div class="right-content">
                                            <h4>{{ station.name }}</h4>
                                            <span>{{ station.location }}</span>
                                            <div class="main-button">
                                                <a href="{% url 'ski_station_detail' station.id %}">{% trans "Découvrez" %}</a>
                                            </div>
                                            <p>{% blocktrans with station_name=station.name %}Découvrez la beauté de {{ station_name }}.{% endblocktrans %}</p>
                                            <ul class="info">
                                              <li><i class="fa fa-user"></i> {% trans "Capacité" %} : {{ station.capacity }}</li>
                                              <li><i class="fa fa-user"></i> {% trans "Pistes" %} : {{ station.num_circuits }}</li>
                                            </ul>
                                            <div class="text-button">
                                              <a href="ski-station/{{ station.id }}">{% trans "Besoin d'indications ?" %} <i class="fa fa-arrow-right"></i></a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        <div class="col-lg-4">
          <div class="side-bar-map">
            <div class="row">
              <div class="col-lg-12">
                <div id="map">
                  <div id="stations-map" style="height: 420px; border-radius: 23px;"></div>
                </div>
                <div class="mt-4 p-3" style="background: #fff; border-radius: 16px;">
                  <h5>{% trans "Stations les plus proches" %}</h5>
                  <ul class="list-unstyled mb-0">
                    {% for station in nearest_stations %}
                      <li class="mb-2 nearest-station-weather" data-lat="{{ station.latitude }}" data-lng="{{ station.longitude }}" data-station-id="{{ station.id }}">
                        <strong>{{ station.name }}</strong><br>
                        <small>{% blocktrans with distance=station.distanceFromGrenoble service_count=station.service_count instructor_count=station.instructor_service_count %}{{ distance }} km de Grenoble • {{ service_count }} services • {{ instructor_count }} offres moniteur{% endblocktrans %}</small>
                        <br>
                        <small id="nearest-wx-{{ station.id }}">{% trans "Météo: chargement..." %}</small>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="pagination-controls">
          <button id="prev-btn" class="pagination-btn">{% trans "Précédent" %}</button>
          <span id="pagination-numbers"></span>
          <button id="next-btn" class="pagination-btn">{% trans "Suivant" %}</button>
        </div>
  
      </div>
    </div>
  </div>


  <!-- Scripts -->
  <!-- Bootstrap core JavaScript -->
  <script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
  <script src="{% static 'vendor/bootstrap/js/bootstrap.min.js'%}"></script>

  <script src="{% static 'js/isotope.min.js'%}"></script>
  <script src="{% static 'js/owl-carousel.js'%}"></script>
  <script src="{% static 'js/tabs.js'%}"></script>
  <script src="{% static 'js/popup.js'%}"></script>
  <script src="{% static 'js/custom.js'%}"></script>

  <script>
    function bannerSwitcher() {
      next = $('.sec-1-input').filter(':checked').next('.sec-1-input');
      if (next.length) next.prop('checked', true);
      else $('.sec-1-input').first().prop('checked', true);
    }

    var bannerTimer = setInterval(bannerSwitcher, 5000);

    $('nav .controls label').click(function() {
      clearInterval(bannerTimer);
      bannerTimer = setInterval(bannerSwitcher, 5000)
    });

    const map = L.map('stations-map').setView([45.188529, 5.724524], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map data © OpenStreetMap contributors'
    }).addTo(map);

    const stations = [
      {% for station in map_stations %}
      {
        name: "{{ station.name|escapejs }}",
        lat: {{ station.latitude }},
        lng: {{ station.longitude }},
        capacity: {{ station.capacity|default:0 }},
        altitude: {{ station.altitude|default:0 }},
        distance: {{ station.distanceFromGrenoble|default:0 }},
        circuits: {{ station.num_circuits|default:0 }},
        services: {{ station.service_count|default:0 }},
        instructorServices: {{ station.instructor_service_count|default:0 }},
        detailUrl: "{% url 'ski_station_detail' station.id %}"
      },
      {% endfor %}
    ];

    function weatherIconClass(main) {
      const key = (main || '').toLowerCase();
      if (key.includes('clear')) return 'fa-sun';
      if (key.includes('snow')) return 'fa-snowflake';
      if (key.includes('rain') || key.includes('drizzle')) return 'fa-cloud-rain';
      if (key.includes('thunderstorm')) return 'fa-bolt';
      if (key.includes('mist') || key.includes('fog')) return 'fa-smog';
      if (key.includes('cloud')) return 'fa-cloud';
      return 'fa-cloud-sun';
    }

    function temperatureClass(temp) {
      if (temp <= -5) return 'text-primary';
      if (temp <= 2) return 'text-info';
      if (temp <= 10) return 'text-secondary';
      if (temp <= 18) return 'text-warning';
      return 'text-danger';
    }

    stations.forEach((station) => {
      const popup = `
        <strong>${station.name}</strong><br>
        Distance: ${station.distance} km<br>
        Altitude: ${station.altitude} m<br>
        Capacity: ${station.capacity}<br>
        Pistes: ${station.circuits}<br>
        Services: ${station.services}<br>
        Moniteur: ${station.instructorServices} offre(s)<br>
        <span id="wx-${station.name.replace(/[^a-zA-Z0-9]/g, '')}">Météo: chargement...</span><br>
        <a href="${station.detailUrl}">Voir détails</a>
      `;
      const marker = L.marker([station.lat, station.lng]).addTo(map).bindPopup(popup);

      marker.on('popupopen', () => {
        const weatherApiKey = '{{ WEATHER_API_KEY }}';
        const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${station.lat}&lon=${station.lng}&appid=${weatherApiKey}&units=metric&lang=fr`;
        const weatherId = `wx-${station.name.replace(/[^a-zA-Z0-9]/g, '')}`;
        fetch(weatherUrl)
          .then((response) => response.json())
          .then((data) => {
            const target = document.getElementById(weatherId);
            if (!target) return;
            if (data && data.main && data.weather && data.weather.length) {
              const icon = weatherIconClass(data.weather[0].main || data.weather[0].description || '');
              const roundedTemp = Math.round(data.main.temp);
              const tempClass = temperatureClass(roundedTemp);
              target.innerHTML = `<i class="fa ${icon}"></i> Météo: ${data.weather[0].description}, <span class="${tempClass}">${roundedTemp}°C</span>`;
            } else {
              target.innerHTML = 'Météo: indisponible';
            }
          })
          .catch(() => {
            const target = document.getElementById(weatherId);
            if (target) target.innerHTML = 'Météo: indisponible';
          });
      });
    });

    const nearestStationRows = document.querySelectorAll('.nearest-station-weather');
    nearestStationRows.forEach((row) => {
      const lat = row.dataset.lat;
      const lng = row.dataset.lng;
      const stationId = row.dataset.stationId;
      const target = document.getElementById(`nearest-wx-${stationId}`);
      if (!lat || !lng || !target) return;

      const weatherApiKey = '{{ WEATHER_API_KEY }}';
      const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${weatherApiKey}&units=metric&lang=fr`;

      fetch(weatherUrl)
        .then((response) => response.json())
        .then((data) => {
          if (data && data.main && data.weather && data.weather.length) {
            const icon = weatherIconClass(data.weather[0].main || data.weather[0].description || '');
            const roundedTemp = Math.round(data.main.temp);
            const tempClass = temperatureClass(roundedTemp);
            target.innerHTML = `<i class="fa ${icon}"></i> Météo: ${data.weather[0].description}, <span class="${tempClass}">${roundedTemp}°C</span>`;
          } else {
            target.innerHTML = 'Météo: indisponible';
          }
        })
        .catch(() => {
          target.innerHTML = 'Météo: indisponible';
        });
    });
  </script>

  </body>

  {% endblock %}